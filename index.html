<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Evolute Kingdom: Mage Duel</title>
    <meta name="app-version" content="EvoluteStudio-Evolute Kingdom: Mage Duel-1.1.46">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="manifest" href="manifest.json">
    <!-- #if SHOW_DIAGNOSTICS -->
    <link rel="stylesheet" href="TemplateData/diagnostics.css">
    <script src="TemplateData/diagnostics.js"></script>
    <!-- #endif -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000000;
        }
        #unity-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            overflow: hidden;
        }
        #unity-canvas {
            width: 100% !important;
            height: 100% !important;
        }
        /* Portrait mode overlay styles */
        #portrait-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        #portrait-icon {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            animation: rotate 2s ease-in-out infinite;
        }
        #portrait-message {
            font-size: 18px;
            font-weight: bold;
            padding: 0 20px;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(90deg); }
        }
    </style>
    <script>
        // Блокуємо автоматичну реєстрацію Service Worker
        window.blockServiceWorkerRegistration = true;
    </script>
    <script src="TemplateData/versionManager.js"></script>
    <script src="TemplateData/orientation.js"></script>
</head>
<body>
<div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar" style="display: none;">
        <div id="unity-logo" style="display: none;"></div>
        <div id="unity-progress-bar-empty" style="display: none;">
            <div id="unity-progress-bar-full"></div>
        </div>
    </div>
    <div id="unity-warning"> </div>
    <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <!-- #if SHOW_DIAGNOSTICS -->
        <img id="diagnostics-icon" src="TemplateData/webmemd-icon.png">
        <!-- #endif -->
        <div id="unity-build-title">Evolute Kingdom: Mage Duel</div>
    </div>
</div>

<!-- Portrait mode overlay -->
<div id="portrait-overlay">
    <svg id="portrait-icon" viewBox="0 0 24 24" fill="white">
        <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3-3H7V4h10v14z"/>
        <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 12 12" to="90 12 12" dur="1s" repeatCount="1"/>
    </svg>
    <div id="portrait-message">
        Please rotate your device to landscape mode for the best experience.
    </div>
</div>

<div id="dev-tools" style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: none;">
    <button id="force-update-btn" style="padding: 5px; background: #ff5722; color: white; border: none; border-radius: 4px; margin-right: 5px;">
        Force Update
    </button>
    <button id="clear-storage-btn" style="padding: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; margin-right: 5px;">
        Clear Storage
    </button>
    <button id="show-version-btn" style="padding: 5px; background: #4caf50; color: white; border: none; border-radius: 4px; margin-right: 5px;">
        Show Version
    </button>
    <button id="activate-sw-btn" style="padding: 5px; background: #9c27b0; color: white; border: none; border-radius: 4px; margin-right: 5px;">
        Activate SW
    </button>
    <button id="reregister-sw-btn" style="padding: 5px; background: #e91e63; color: white; border: none; border-radius: 4px;">
        Reregister SW
    </button>
    <button id="update-meta-btn" style="padding: 5px; background: #009688; color: white; border: none; border-radius: 4px; margin-right: 5px;">
        Update from Meta
    </button>
</div>

<script src="TemplateData/unityLoader.js"></script>
<script>
    // Показуємо інструменти розробника при натисканні Ctrl+Shift+D
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            const devTools = document.getElementById('dev-tools');
            devTools.style.display = devTools.style.display === 'none' ? 'block' : 'none';
        }
    });
    
    // Обробник для кнопки примусового оновлення
    document.getElementById('force-update-btn').addEventListener('click', function() {
        window.location.href = window.location.pathname + '?force-update=true';
    });
    
    // Обробник для кнопки очищення сховища
    document.getElementById('clear-storage-btn').addEventListener('click', function() {
        localStorage.clear();
        sessionStorage.clear();
        alert('Local storage and session storage cleared. Reloading page...');
        window.location.reload();
    });
    
    // Обробник для кнопки показу версії
    document.getElementById('show-version-btn').addEventListener('click', function() {
        const metaVersion = document.querySelector('meta[name="app-version"]')?.content || 'Not found';
        const storedVersion = localStorage.getItem('app_version') || 'Not found';
        alert(`Meta version: ${metaVersion}\nStored version: ${storedVersion}`);
    });
    
    // Обробник для кнопки активації Service Worker
    document.getElementById('activate-sw-btn').addEventListener('click', function() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(function(reg) {
                if (reg && reg.waiting) {
                    // Встановлюємо обробник для події controllerchange
                    let refreshing = false;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (!refreshing) {
                            refreshing = true;
                            alert('Service Worker activated! Reloading page...');
                            window.location.reload();
                        }
                    });
                    
                    // Відправляємо повідомлення для активації
                    reg.waiting.postMessage({ action: 'skipWaiting' });
                } else {
                    alert('No waiting Service Worker found');
                }
            });
        } else {
            alert('Service Worker API not supported');
        }
    });
    
    // Обробник для кнопки перереєстрації Service Worker
    document.getElementById('reregister-sw-btn').addEventListener('click', function() {
        if ('serviceWorker' in navigator) {
            if (confirm('This will unregister all Service Workers and register a new one. Continue?')) {
                // Викликаємо функцію з versionManager.js
                forceReregisterServiceWorker().then(success => {
                    if (success) {
                        alert('Service Worker successfully re-registered. Reloading page...');
                        window.location.reload();
                    } else {
                        alert('Failed to re-register Service Worker.');
                    }
                });
            }
        } else {
            alert('Service Worker API not supported');
        }
    });
    
    // Обробник для кнопки оновлення з мета-тегу
    document.getElementById('update-meta-btn').addEventListener('click', function() {
        const metaVersion = document.querySelector('meta[name="app-version"]')?.content;
        if (metaVersion) {
            localStorage.setItem('app_version', metaVersion);
            alert(`Version updated to: ${metaVersion}. Reloading page...`);
            window.location.reload();
        } else {
            alert('Meta version tag not found!');
        }
    });
</script>
</body>
</html>
